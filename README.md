<div align="center">

# LHCO EPiC Flow Matching

[![python](https://img.shields.io/badge/-Python_3.10-blue?logo=python&logoColor=white)](https://www.python.org/)
[![pytorch](https://img.shields.io/badge/PyTorch_2.0+-ee4c2c?logo=pytorch&logoColor=white)](https://pytorch.org/get-started/locally/)
[![lightning](https://img.shields.io/badge/-Lightning_2.0+-792ee5?logo=pytorchlightning&logoColor=white)](https://pytorchlightning.ai/)
[![hydra](https://img.shields.io/badge/Config-Hydra_1.3-89b8cd)](https://hydra.cc/)
[![black](https://img.shields.io/badge/Code%20Style-Black-black.svg?labelColor=gray)](https://black.readthedocs.io/en/stable/)
[![isort](https://img.shields.io/badge/%20imports-isort-%231674b1?style=flat&labelColor=ef8336)](https://pycqa.github.io/isort/) <br>
<a href="https://github.com/ashleve/lightning-hydra-template"><img alt="Template" src="https://img.shields.io/badge/-Lightning--Hydra--Template-017F2F?style=flat&logo=github&labelColor=gray"></a>
[![Paper](http://img.shields.io/badge/paper-arxiv.1001.2234-B31B1B.svg)](https://www.nature.com/articles/nature14539)
[![Conference](http://img.shields.io/badge/AnyConference-year-4b44ce.svg)](https://papers.nips.cc/paper/2020)

</div>

## Description

This repository contains the code for the Flow Matching Generative Models from [XXX](https://arxiv.org/abs/1111.11111). For the preparation of the data see this [repository](https://github.com/ewencedr/FastJet-LHCO), the second generative model and the classifier can be found [here](https://github.com/ViniciusMikuni/LHCO_diffusion). 
We used the [LHC Olympics](https://lhco2020.github.io/homepage/) R&D anomaly detection dataset.

> Physics beyond the Standard Model that is resonant in one or more dimensions has been a
longstanding focus of countless searches at colliders and beyond. Recently, many new strategies
for resonant anomaly detection have been developed, where sideband information can be used in
conjunction with modern machine learning, in order to generate synthetic datasets representing the
Standard Model background. Until now, this approach was only able to accommodate a relatively
small number of dimensions, limiting the breadth of the search sensitivity. Using recent innovations
in point cloud generative models, we show that this strategy can also be applied to the full phase
space, using all relevant particles for the anomaly detection. As a proof of principle, we show that
the signal from the R&D dataset from the LHC Olympics is findable with this method, opening up
the door to future studies that explore the interplay between depth and breadth in the representation
of the data for anomaly detection.

For the generation of dijet events, we use a chain of multiple generative models. One particle feature Model generates the jet constituents based on jet features that are generated by a jet feature model. The jet feature model generates the jet features for both jets in the event and is conditioned on the dijet mass of the jet pair. This conditioniong allows us to train on sideband region in dijet mass and sample in the signal region, where a signal is expected. 

The particle feature model is the EPiC Flow Matching model introduced [here](https://arxiv.org/abs/2310.00049).
EPiC Flow Matching is a [Continuous Normalising Flow](https://arxiv.org/abs/1806.07366) that is trained with a simulation free approach called [Flow Matching](https://arxiv.org/abs/2210.02747). The model uses [DeepSet](https://arxiv.org/abs/1703.06114) based [EPiC layers](https://arxiv.org/abs/2301.08128) for the architecture, which allow for good scalability to high set sizes.

The jet feature model is also trained with Flow Matching, but since it doesn't model point clouds, a simple fully connected architecture is used.

This repository uses [pytorch lightning](https://www.pytorchlightning.ai/index.html), [hydra](https://hydra.cc/docs/intro/) for model configurations and supports logging with [comet](https://www.comet.com/site/) and [wandb](https://wandb.ai/site). For a deeper explanation of how to use this repository, please have a look at the [template](https://github.com/ashleve/lightning-hydra-template) directly.

## How to run

Install dependencies

```bash
# clone project
git clone https://github.com/YourGithubName/your-repo-name
cd your-repo-name

# [OPTIONAL] create conda environment
conda create -n myenv python=3.10
conda activate myenv

# install pytorch according to instructions
# https://pytorch.org/get-started/

# install requirements
pip install -r requirements.txt
```

Create .env file to set paths and API keys

```bash
PROJEKT_ROOT="/folder/folder/"
DATA_DIR="/folder/folder/"
LOG_DIR="/folder/folder/"
COMET_API_TOKEN="XXXXXXXXXX"
```

Before training, the [data](https://lhco2020.github.io/homepage/) needs to be downloaded. Because the data simply consists of all jet constituents from a dijet event, the data has to be clustered and prepared first. This can be done with [this](https://github.com/ewencedr/FastJet-LHCO) code.

Then the jet feature model can be trained with

```bash
python src/train.py experiment=lhco/lhco_jet_features
```


and the particle feature model with

```bash
python src/train.py experiment=lhco/lhco_both_jets
```
After training both models, one can generate the events with the `lhco_full_eval` notebook. The classifier training and evaluation plots were done with [this](https://github.com/ViniciusMikuni/LHCO_diffusion) code.
